<!DOCTYPE html>
<html>
<head>
  <title>Speed & Distance Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
    #controls { padding: 10px; }
    button { padding: 10px 20px; font-size: 1em; margin: 5px; }
    #speed, #distance { font-size: 1.5em; margin: 10px 0; }
    #map { height: 50vh; }
  </style>
</head>
<body>

  <div id="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <div id="speed">Speed: 0 km/h</div>
    <div id="distance">Distance: 0 km</div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let watching = false;
    let watchId;
    let velocity = 0;
    let distance = 0;
    let lastGPSUpdate = 0;
    let lastPosition = null;
    let lastAccTime = null;

    const speedEl = document.getElementById("speed");
    const distanceEl = document.getElementById("distance");

    // Initialize map
    const map = L.map("map").setView([0, 0], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    let path = L.polyline([], { color: "blue" }).addTo(map);

    function updateDisplay() {
      speedEl.textContent = `Speed: ${(velocity * 3.6).toFixed(2)} km/h`;
      distanceEl.textContent = `Distance: ${(distance / 1000).toFixed(3)} km`;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000; // meters
      const toRad = angle => angle * (Math.PI / 180);
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function startTracking() {
      if (!("geolocation" in navigator)) {
        alert("Geolocation not supported.");
        return;
      }

      watching = true;
      distance = 0;
      lastPosition = null;
      path.setLatLngs([]);

      // GPS
      watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, speed } = pos.coords;
          const current = [latitude, longitude];

          if (!lastPosition) {
            lastPosition = pos.coords;
            map.setView(current, 16);
          } else {
            const d = haversine(
              lastPosition.latitude,
              lastPosition.longitude,
              latitude,
              longitude
            );
            if (d < 100) distance += d; // filter large jumps
            lastPosition = pos.coords;
          }

          if (speed !== null && !isNaN(speed)) {
            velocity = speed;
            lastGPSUpdate = Date.now();
          }

          path.addLatLng(current);
          updateDisplay();
        },
        err => console.warn("GPS error", err),
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000,
        }
      );

      // Accelerometer
      window.addEventListener("devicemotion", onMotion);
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = false;
    }

    function stopTracking() {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      window.removeEventListener("devicemotion", onMotion);
      watching = false;
      velocity = 0;
      updateDisplay();
      document.getElementById("startBtn").disabled = false;
      document.getElementById("stopBtn").disabled = true;
    }

    function onMotion(event) {
      const acc = event.acceleration;
      const t = Date.now();

      if (lastAccTime && acc && acc.x !== null && acc.y !== null && acc.z !== null) {
        const dt = (t - lastAccTime) / 1000;
        const totalAcc = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2) - 9.81;

        if (Math.abs(totalAcc) > 0.2) {
          velocity += totalAcc * dt;
          if (velocity < 0) velocity = 0;
          if (t - lastGPSUpdate > 3000) updateDisplay();
        }
      }

      lastAccTime = t;
    }

    document.getElementById("startBtn").onclick = startTracking;
    document.getElementById("stopBtn").onclick = stopTracking;
  </script>
</body>
</html>
